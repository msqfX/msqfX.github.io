(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{377:function(s,a,e){"use strict";e.r(a);var t=e(0),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"kubernetes-service如何通过iptables转发"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-service如何通过iptables转发"}},[s._v("#")]),s._v(" kubernetes service如何通过iptables转发")]),s._v(" "),e("h2",{attrs:{id:"前言"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),e("p",[s._v("本文主要是介绍kubernetes的service是如何利用iptables来进行流量的转发达到流量的负载均衡的，并会通过实践操作来更好的理解与验证其原理。")]),s._v(" "),e("h2",{attrs:{id:"环境搭建"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#环境搭建"}},[s._v("#")]),s._v(" 环境搭建")]),s._v(" "),e("p",[s._v("搭建环境如下图所示：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gcore.jsdelivr.net/gh/msqfx/BLOG-CDN@main/image-20240110142336-wl40wxw.png",alt:""}})]),s._v(" "),e("ol",[e("li",[s._v("创建一个deploy，设置其副本数为3")])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" demoapp"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("deployment\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" demoapp\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" demoapp\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" demoapp\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ubuntu\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ikubernetes/demoapp"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("v1.0\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])]),e("ol",{attrs:{start:"2"}},[e("li",[s._v("创建service，为上面deployment的3个pod进行负载均衡访问")])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" demoapp"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" demoapp\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("clusterIP")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.44.140.73\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" http\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("验证")])]),s._v(" "),e("p",[s._v("创建完后，环境如下：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods -n zwf -o wide")]),s._v("\nNAME                                  READY   STATUS    RESTARTS   AGE     IP\ndemoapp-deployment-64bdcb8666-4prbk   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          7d17h   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.33")]),s._v(".229.12   dmoc-fa163eee1e30\ndemoapp-deployment-64bdcb8666-cxmmz   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          7d17h   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.33")]),s._v(".73.139   dmoc-fa163e7188d6\ndemoapp-deployment-64bdcb8666-kkzsg   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          7d17h   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.33")]),s._v(".206.93   dmoc-fa163ee6bbe1\ndemoapp-pod                           "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          4d17h   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.33")]),s._v(".73.172   dmoc-fa163e7188d6\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc -n zwf")]),s._v("\nNAME                       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("        AGE\ndemoapp-service            ClusterIP   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.44")]),s._v(".140.73    "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("/TCP         7s\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("可以直接在环境中请求service的clusterip地址，会随机访问到三个pod，输出的信息包含了请求IP和目的IP。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 192.44.140.73")]),s._v("\niKubernetes demoapp v1.0 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" ClientIP: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.10")]),s._v(".10.16, ServerName: demoapp-deployment-64bdcb8666-kkzsg, ServerIP: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.33")]),s._v(".206.93"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 192.44.140.73")]),s._v("\niKubernetes demoapp v1.0 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" ClientIP: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".196.41, ServerName: demoapp-deployment-64bdcb8666-cxmmz, ServerIP: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.33")]),s._v(".73.139"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 192.44.140.73")]),s._v("\niKubernetes demoapp v1.0 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" ClientIP: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.10")]),s._v(".10.16, ServerName: demoapp-deployment-64bdcb8666-4prbk, ServerIP: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.33")]),s._v(".229.12"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("h2",{attrs:{id:"kube-services"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kube-services"}},[s._v("#")]),s._v(" KUBE-SERVICES")]),s._v(" "),e("p",[s._v("在"),e("code",[s._v("PREROUTING")]),s._v("​和"),e("code",[s._v("OUTPUT")]),s._v("​链的nat表中，都包含了"),e("code",[s._v("KUBE-SERVICES")]),s._v("​子链，该子链中就包含了serivce的iptables规则的配置。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L PREROUTING -t nat")]),s._v("\nChain PREROUTING "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination       \nKUBE-SERVICES  all  --  anywhere             anywhere             /* kubernetes "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" portals */\ncali-PREROUTING  all  --  anywhere             anywhere             /* cali:6gwbT8clXdHdC1b1 */\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L OUTPUT -t nat")]),s._v("\nChain OUTPUT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination       \nKUBE-SERVICES  all  --  anywhere             anywhere             /* kubernetes "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" portals */\ncali-OUTPUT  all  --  anywhere             anywhere             /* cali:tVnHkvAo15HuiPy0 */\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("p",[e("strong",[s._v("为什么在PREROUTING和OUTPUT链中添加service规则？")])]),s._v(" "),e("p",[s._v("service的作用是负载均衡，也就是需要将IP包进行DNAT操作，而这个操作需要在最靠近发送的位置。网卡收到的包进入到网络协议栈时，最先进入的就是PREROUTING链，也就是节点外部的流量进入的入口。OUTPUT是本地进程发出的包最先进入的链。所以需要在这两条链中添加"),e("code",[s._v("KUBE-SERVICES")]),s._v("，详情可参考"),e("a",{attrs:{href:"https://www.zhengwenfeng.com/pages/72ba9a/",target:"_blank",rel:"noopener noreferrer"}},[s._v("快速了解iptables"),e("OutboundLink")],1)]),s._v(" "),e("p",[e("strong",[s._v("为什么nat表？")])]),s._v(" "),e("p",[s._v("因为要做DNAT操作，所以在nat表。")]),s._v(" "),e("p",[s._v("KUBE-SERVICES下面有许多KUBE-SVC-XXX的子链，每一条子链都是一个集群中一个service的配置，筛选一下")]),s._v(" "),e("p",[s._v("通过筛选"),e("code",[s._v("demoapp-service")]),s._v("​得到下面的子链，只有访问目的地址为192.44.140.73才能进入到该子链中。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L KUBE-SERVICES -t nat | grep demoapp-service")]),s._v("\nKUBE-SVC-FIHIHDNRZEG5VQEQ  tcp  --  anywhere             "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.44")]),s._v(".140.73        /* zwf/demoapp-service:http cluster IP */ tcp dpt:http\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("查看"),e("code",[s._v("UBE-SVC-FIHIHDNRZEG5VQEQ")]),s._v("​链中内容，其中包含了四条子链。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L KUBE-SVC-FIHIHDNRZEG5VQEQ -t nat -n")]),s._v("\nChain KUBE-SVC-FIHIHDNRZEG5VQEQ "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" references"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination       \nKUBE-MARK-MASQ  tcp  -- "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.33")]),s._v(".0.0/16        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.44")]),s._v(".140.73        /* zwf/demoapp-service:http cluster IP */ tcp dpt:80\nKUBE-SEP-FO7YK2K5DAKTCVSE  all  --  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0/0            "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0/0            /* zwf/demoapp-service:http */ statistic mode random probability "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.33333333349")]),s._v("\nKUBE-SEP-IPKL7NSNTVGKI4T5  all  --  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0/0            "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0/0            /* zwf/demoapp-service:http */ statistic mode random probability "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.50000000000")]),s._v("\nKUBE-SEP-BPER562ISF3UFYOQ  all  --  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0/0            "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0/0            /* zwf/demoapp-service:http */\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("第一条链是，源IP不在192.33.0.0/16段、目的IP为192.44.140.73并且目的端口是80的数据包会匹配到该条子链进行跳转。其中192.33.0.0/16是pod的网段，如果不是集群内的流量，则会匹配上该条子链，会打上0x4000的标记。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L KUBE-MARK-MASQ -t nat -n")]),s._v("\nChain KUBE-MARK-MASQ "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("548")]),s._v(" references"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination       \nMARK       all  --  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0/0            "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0/0            MARK or 0x4000\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("后面的三条链是为了将流量随机的分配到任意一个pod中。第二条链代表着有1/3的概率会匹配到该链，而第三条链代表着1/2，最后一条链代表着百分百。")]),s._v(" "),e("p",[s._v("看第二条链中的规则，第一条规则是跳转到子链"),e("code",[s._v("KUBE-MARK-MASQ")]),s._v("​，源IP为192.33.206.93的数据包打上了0x4000标记，再将目的IP DNAT成192.33.206.93，说明如果自己访问自己，也会被打上标记。")]),s._v(" "),e("p",[s._v("这里的192.33.206.93是本身service所匹配上的pod IP地址，如果调用自己的service则会匹配上该链，打上0x4000标记。")]),s._v(" "),e("p",[s._v("而第二条规则是一个DNAT操作，会将目标地址改为192.33.206.93:80，也就是pod的地址。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L KUBE-SEP-FO7YK2K5DAKTCVSE -t nat")]),s._v("\nChain KUBE-SEP-FO7YK2K5DAKTCVSE "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" references"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination   \nKUBE-MARK-MASQ  all  --  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.33")]),s._v(".206.93        anywhere             /* zwf/demoapp-service:http */\nDNAT       tcp  --  anywhere             anywhere             /* zwf/demoapp-service:http */ tcp to:192.33.206.93:80\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("剩下的第3、4条规则也是一样的操作，会将流量DNAT到对应的pod中。")]),s._v(" "),e("h2",{attrs:{id:"postrouting"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#postrouting"}},[s._v("#")]),s._v(" POSTROUTING")]),s._v(" "),e("p",[s._v("POSTROUTING中包含了一条KUBE-POSTROUTING子链，子链也是由kube-porxy来写入的。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L POSTROUTING -t nat")]),s._v("\nChain POSTROUTING "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination       \nKUBE-POSTROUTING  all  --  anywhere             anywhere             /* kubernetes postrouting rules */\ncali-POSTROUTING  all  --  anywhere             anywhere             /* cali:O3lYWMrLQYEMJtB5 */\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("查看子链"),e("code",[s._v("KUBE-POSTROUTING")]),s._v("​内容：")]),s._v(" "),e("ol",[e("li",[s._v("第一条规则是没有标记为0x400的数据包会return，不执行下面的子链。还记得在"),e("code",[s._v("KUBE-PREROUTING")]),s._v("​中有两次打上0x4000标记，代表着访问是集群外部访问该service或者是源和目的一样，都会往下走。")]),s._v(" "),e("li",[s._v("第二条规则是对数据包的标记值进行异或，而这里是0x4000与0x4000进行异或，也就是0")]),s._v(" "),e("li",[s._v("第三条规则时对该数据包进行SNAT，random-fully是对源端口进行随机获取。")])]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L KUBE-POSTROUTING -t nat")]),s._v("\nChain KUBE-POSTROUTING "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" references"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination       \nRETURN     all  --  anywhere             anywhere             mark match "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" 0x4000/0x4000\nMARK       all  --  anywhere             anywhere             MARK xor 0x4000\nMASQUERADE  all  --  anywhere             anywhere             /* kubernetes "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" traffic requiring SNAT */ random-fully\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("这里有两种情况会被SNAT，说说为什么。")]),s._v(" "),e("h2",{attrs:{id:"snat"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#snat"}},[s._v("#")]),s._v(" SNAT")]),s._v(" "),e("h3",{attrs:{id:"为什么集群外部访问该service需要被snat"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#为什么集群外部访问该service需要被snat"}},[s._v("#")]),s._v(" 为什么集群外部访问该service需要被SNAT？")]),s._v(" "),e("p",[s._v("数据包需要回包，如果没有SNAT，那么回包的目的IP是客户端的IP，而源IP是Pod的IP，而客户端并不认该数据包，则会被丢弃。")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gcore.jsdelivr.net/gh/msqfx/BLOG-CDN@main/image-20240108193022-uocio0v.png",alt:""}}),s._v("\n‍")]),s._v(" "),e("p",[s._v("如果有发生SNAT，那么回包的时候可以回到Node1的节点，再回到client。")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gcore.jsdelivr.net/gh/msqfx/BLOG-CDN@main/image-20240108192557-pxds0fc.png",alt:""}}),s._v("‍")]),s._v(" "),e("p",[s._v("但问题又来了，是怎么从Node1再回包到client的呢？")]),s._v(" "),e("h3",{attrs:{id:"conntrack"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#conntrack"}},[s._v("#")]),s._v(" conntrack")]),s._v(" "),e("p",[s._v("conntrack是一个追踪表，在每一个数据包进入到netfilter的时候，都会记录一条记录，当我们进行SNAT和DNAT的时候也都会更新该表中的记录。")]),s._v(" "),e("p",[s._v("所以在Node1回包给client时候，可以通过查询这个表中的记录，然后再次SNAT和DNAT恢复回去就可以进行正常的回包了。")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gcore.jsdelivr.net/gh/msqfx/BLOG-CDN@main/20240118185404.png",alt:""}})]),s._v(" "),e("p",[s._v("可以看下conntrack里面的记录长什么样子。")]),s._v(" "),e("p",[s._v("先在某一台节点上curl service的ip，上图的client其实也是在Node1上的，因为Node1上有两张网卡，Node1和Node2的通信使用的网卡eth2 ip为10.10.10.16，因为转发到其他节点，所以会被SNAT。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 192.44.140.73")]),s._v("\niKubernetes demoapp v1.0 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" ClientIP: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.10")]),s._v(".10.16, ServerName: demoapp-deployment-64bdcb8666-4prbk, ServerIP: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.33")]),s._v(".229.12"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("这里主要是看src和dst分别是client请求service的目的IP，然后后面又有一个src和dst它是由Node2回包给Node1的源和目的IP，也就是源是pod的IP，dst是Node1节点IP。")]),s._v(" "),e("p",[s._v("前面是发送包的方向，后面是回包的方向。通过查询该表，即可以从Node1回包给client")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# conntrack -L | grep 192.33.229.12")]),s._v("\ntcp      "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("107")]),s._v(" TIME_WAIT "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("src")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".196.41 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dst")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.44")]),s._v(".140.73 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("sport")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("33468")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dport")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("src")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.33")]),s._v(".229.12 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dst")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.10")]),s._v(".10.16 "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("sport")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dport")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("18623")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ASSURED"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("mark")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("use")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("‍")]),s._v(" "),e("h2",{attrs:{id:"源和目的ip相同"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#源和目的ip相同"}},[s._v("#")]),s._v(" 源和目的IP相同")]),s._v(" "),e("p",[s._v("当pod访问service时，正好DNAT成自己的IP，那么就存在源和目的IP一样的情况。")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gcore.jsdelivr.net/gh/msqfx/BLOG-CDN@main/image-20240108194618-1alci1m.png",alt:""}})]),s._v(" "),e("p",[s._v("这种数据包是很特殊的存在，网络设备可能会将这种数据包视为无效或者异常的包被丢弃，最好不要一样，所以会将源IP SNAT为主机的IP，解决该问题。")]),s._v(" "),e("p",[e("strong",[s._v("实验")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://gcore.jsdelivr.net/gh/msqfx/BLOG-CDN@main/image-20240108200310-r3nr3es.png",alt:""}})]),s._v(" "),e("p",[s._v("当前节点的IP为：10.65.196.41，然后进入在当前节点的Pod内，当前pod的ip为：192.33.73.139")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" zwf demoapp-deployment-64bdcb8666-cxmmz -- "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v("\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("进行多次curl service ip，当某一次请求到本POD的IP时，查看其ClientIP，发现其源IP是：10.65.196.41，这个当前节点的IP")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 192.44.140.73")]),s._v("\niKubernetes demoapp v1.0 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" ClientIP: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".196.41, ServerName: demoapp-deployment-64bdcb8666-cxmmz, ServerIP: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.33")]),s._v(".73.139"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h2",{attrs:{id:"nodeport"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nodeport"}},[s._v("#")]),s._v(" NodePort")]),s._v(" "),e("p",[s._v("上面介绍的是serivi type=ClusterIP方式的，那么NodePort有什么区别呢？")]),s._v(" "),e("h3",{attrs:{id:"搭建环境"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#搭建环境"}},[s._v("#")]),s._v(" 搭建环境")]),s._v(" "),e("p",[s._v("先将clusterIP的service删了，防止干扰。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl delete svc "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" zwf demoapp-service\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("创建NodePort的service文件"),e("code",[s._v("demo_service_nodeport.yaml")]),s._v("​")]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" demoapp"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("nodeport"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" demoapp\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" http\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NodePort\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("p",[s._v("创建Service")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -n zwf -f demo_service_nodeport.yaml ")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc -n zwf")]),s._v("\nNAME                       TYPE       CLUSTER-IP       EXTERNAL-IP   PORT"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("        AGE\ndemoapp-nodeport-service   NodePort   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.44")]),s._v(".152.223   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(":30337/TCP   64s\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h3",{attrs:{id:"请求clusterip"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#请求clusterip"}},[s._v("#")]),s._v(" 请求clusterip")]),s._v(" "),e("p",[s._v("通过clusterip+端口的方式请求service，原理和上面将是一样的。")]),s._v(" "),e("p",[s._v("在POSTROUTING和OUTPUT中添加了KUBE-SERVICES链，其中包含了新增的service对应的KUBE-SVC-XXX子链，当访问的是其clusterip时，则匹配上该链。在其中包含了从多个pod中随机选择一个进行DNAT操作，打上标记，在POSTROUTING中再SNAT。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L PREROUTING -t nat")]),s._v("\nChain PREROUTING "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination       \nKUBE-SERVICES  all  --  anywhere             anywhere             /* kubernetes "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" portals */\ncali-PREROUTING  all  --  anywhere             anywhere             /* cali:6gwbT8clXdHdC1b1 */\n\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L KUBE-SERVICES -t nat | grep zwf")]),s._v("\nKUBE-SVC-YSWRJGOK5VEB6HOG  tcp  --  anywhere             "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.44")]),s._v(".152.223       /* zwf/demoapp-nodeport-service:http cluster IP */ tcp dpt:http\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L KUBE-SVC-YSWRJGOK5VEB6HOG -t nat |grep zwf")]),s._v("\nKUBE-MARK-MASQ  tcp  -- "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.33")]),s._v(".0.0/16        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.44")]),s._v(".152.223       /* zwf/demoapp-nodeport-service:http cluster IP */ tcp dpt:http\nKUBE-MARK-MASQ  tcp  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */ tcp dpt:30337\nKUBE-SEP-NMMBRSZXI4OIWDPB  all  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */ statistic mode random probability "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.33333333349")]),s._v("\nKUBE-SEP-PXDORKZI3GD2RUMC  all  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */ statistic mode random probability "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.50000000000")]),s._v("\nKUBE-SEP-YLPOR67MTHPHIZAB  all  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("h3",{attrs:{id:"请求节点ip"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#请求节点ip"}},[s._v("#")]),s._v(" 请求节点IP")]),s._v(" "),e("p",[s._v("但是如果不是通过ClusterIP而是通过节点IP请求service呢，它是怎么做的？")]),s._v(" "),e("p",[s._v("因为是节点IP，所以无法匹配上该service的KUBE-SVC-XXX子链，但是有一条"),e("code",[s._v("KUBE-NODEPORTS")]),s._v("​")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L KUBE-SERVICES  -t nat | grep KUBE-NODEPORTS")]),s._v("\nKUBE-NODEPORTS  all  --  anywhere             anywhere             /* kubernetes "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" nodeports"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" NOTE: this must be the last rule "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" this chain */ ADDRTYPE match dst-type LOCAL\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("在其中包含了一条子链"),e("code",[s._v("KUBE-SVC-YSWRJGOK5VEB6HOG")]),s._v("​，只要目的端口为30337就能匹配上，而这个端口正好就是"),e("code",[s._v("demoapp-nodeport-service")]),s._v("​的NodePort端口。")]),s._v(" "),e("p",[s._v("这条子链和上面匹配clusterIP时是同一个链，都是进行一个DNAT操作。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# # iptables -L KUBE-NODEPORTS -t nat | grep zwf")]),s._v("\nKUBE-SVC-YSWRJGOK5VEB6HOG  tcp  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */ tcp dpt:30337\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("‍")]),s._v(" "),e("h2",{attrs:{id:"参考链接"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[s._v("#")]),s._v(" 参考链接")]),s._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/liushaodong/archive/2013/02/26/2933593.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("netfilter 链接跟踪机制与NAT原理"),e("OutboundLink")],1)]),s._v(" "),e("li",[e("a",{attrs:{href:"https://www.jianshu.com/p/33c563045e76",target:"_blank",rel:"noopener noreferrer"}},[s._v("k8s 之 service ip"),e("OutboundLink")],1)]),s._v(" "),e("li",[e("a",{attrs:{href:"https://www.thebyte.com.cn/network/conntrack.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("连接跟踪 conntrack"),e("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=n.exports}}]);